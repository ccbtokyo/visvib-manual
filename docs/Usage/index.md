# 実践編

## アプリケーションの起動

まず、アプリケーションを起動しましょう。[ダウンロードしてから初回の起動時はシステムに起動をブロックされることがありますが、無視して起動してください。](../Troubleshooting/index.md#_2)

![Windowsのエクスプローラーでフォルダ内のccbt_tonechime_sensorというMax Projectファイルをクリックしているところ。](../img/launch_maxapp.png)

音声・照明アプリケーションのフォルダ内の、`ccbt_tonechime_sensor`というMaxプロジェクトファイルをダブルクリックすると、Max上でアプリケーションが起動します。

![音声/照明アプリケーションのスクリーンショット。](../img/screenshot-mainapp.png)


映像アプリケーションは、映像アプリケーションフォルダ内の `Tonechime_VideoSystem` というアプリケーションをダブルクリックすると起動します。この時、外部ディスプレイを繋いでいると、映像アプリケーションが自動的に全画面で表示されます。メインディスプレイには、小さな操作ウィンドウが表示されます。アプリケーションを立ち上げたら、はじめに、オーディオインターフェースやDMXの接続設定をします。

![外部ディスプレイを繋げた状態で映像アプリケーションを立ち上げたところ。](../img/video-system.png)

## オーディオインターフェースの設定

![音声・照明アプリケーションのスクリーンショット。オーディオ設定のウィンドウの開き方の説明。"Audio Setting"というボタンの上にカーソルが置かれており、メインアプリケーション左上側にAUDIO STATUSというタイトルの小さなウィンドウが立ち上がっている。](../img/select-audiointerface.png)

まず、右上のSystemという枠内の、"Audio Setting"ボタンをクリックします。

![オーディオインターフェースの選択の説明。INPUT DEVICEという項目のボタンがクリックされ、上から順にNone、In 1-2(Roland Rubix)、マイク配列（MIPI SoundWire）という3つが候補として表示されており、2番目のRolandにカーソルを合わせている。](../img/select-audiointerface2.png)

新しくウィンドウが立ち上がるので、上から2番目のDRIVERという項目で"ad_portaudio"または"Windows DirectSound"（Macなら"Core Audio"）、3番目のINPUT DEVICEで、使用しているオーディオインターフェースの名前を選択します。また、SAMPLING RATEは48000に設定してください。終わったらオーディオ設定ウィンドウを閉じます。

![音声・照明アプリケーションのスクリーンショット。”Audio Setting”の上にある"DSP"ボタンにカーソルが合っており、緑色に点灯している。](../img/select-audiointerface3.png)

その後、"Audio Setting"の上にある"DSP"のボタンが灰色なら、クリックして緑色になるようにします。

## 照明の設定

![音声・照明アプリケーションのスクリーンショット。DMX_ENABLEというボタンにカーソルが合っており、緑色に点灯している。その右隣のインジケーターも緑に点灯しており、右側には”Connected”と表示されている。やや下に”COM3”というデバイス名が表示されている。](../img/dmx-enable.png)

Systemの下側の”Device Communication”という枠内の`DMX_DISABLE/DMX_ENABLE`のボタンも緑色(ENABLE)になるようにクリックします。DMX USB PROが正しく接続されていれば、右隣のインジケーターが緑色に光り、"Connected"と表示されます。

> [!NOTE]
> アプリケーションは、USB経由で接続されているシリアル通信を行う機器を自動的に検出します。複数台シリアルデバイスが接続されているとDMX USB PRO以外の機器に接続を試みてしまうので、システムに関係ないUSB機器は接続しないようにしてください。

![音声・照明アプリケーションのスクリーンショット。OSCというボタンが緑色に点灯しており、その下のLOCAL_MODEというボタンにカーソルが合い、黄色に点灯している。](../img/osc-enable.png)

さらにその下の、"OSC"ボタンも緑色になるように、また"LOCAL_MODE"も黄色になるようにクリックします。

> [!NOTE]
> "LOCAL_MODE"をオフにすると、別のコンピューターで起動している映像アプリケーションと同期することができます。映像アプリケーションを立ち上げているコンピューターのIPアドレスをportの左隣のaddressという欄に入力してください。

## 設定の保存

![音声・照明アプリケーションのスクリーンショット。右上"Save Config"という部分にカーソルが合っており、ボタンが赤く点灯している。](../img/save_config.png)

接続に問題がなければ右上の"Save Config"ボタンをクリックしてください。接続している機器の構成が同じなら、次回アプリケーションを立ち上げた時に、オーディオインターフェースの設定を含め、現在の設定が自動で復元されます。

> [!NOTE]
> パラメーターは`data/main.json`というファイルの中に書き込まれています。JSONデータ内の`pattrstorage/slots/1/data` を直接編集することでも編集できます。

## トーンチャイムの音程と音量の設定

![音程設定部分を囲んだスクリーンショット](../img/adjust-pitch.png)

音声・照明プログラムでは、あらかじめ使うトーンチャイムの音程をプログラム側で指定することで、余計なノイズの検出を防いでいます。アプリの画面下半分のセクションで、トーンチャイムの音程と音量をそれぞれ調節することができます。

各チャンネルごとに"Pitch"というダイアルをドラッグして、使っているトーンチャイムの音程の名前に合わせます。また、右側のBPFというボタンが黄色く光っていることを確認してください[^bpf]。

> [!NOTE]
> ソフトウェア上では黒鍵の音程が`A#4`や`D#4`などシャープで表記されてますが、トーンチャイムでは`B♭4`や`E♭4` などフラット表記になっているので、間違えないようにしましょう。

[^bpf]: 音程感のない打楽器などにVisVibのシステムを応用する場合、BPFのボタンをオフにすることで音に反応しやすくなる可能性があります。ただし、ノイズの検出率も上がるので注意してください。

次に、コンタクトマイクの音量（感度）を設定しましょう。トーンチャイムを叩いた時に、アプリケーション上でgainと書いてある部分のメーターに音の大きさが表示されます。

オーディオインターフェースの入力gainのつまみを、強めにトーンチャイムを叩いた時に、メーターが赤や黄色にならない程度まで右に回して上げていきます。

![入力つまみ部分の写真](../img/audiointerface_gain.jpg)

もし、オーディオインターフェース側でピーク過大入力のランプが点灯したり、つまみを上げ切ったけどまだ音量が小さい、という場合には、アプリケーション上でゲインのメーターをドラッグし、さらに音量を調整してください。

複数トーンチャイムを使う時は、すべてのチャンネルでピッチと音量の調整を行なってください。再び、"Save Config"を押して、設定を保存しておきましょう。

## 照明の設定

![ライト周りのスクリーンショット](../img/test-lightslider.png)

照明の設定を行います。まず、Light Brightnessというスライダーを左右にドラッグして、照明の明るさが変化するかチェックしましょう。これを動かしても明るさが変化しない場合は、[セットアップ編でのDMXや照明の接続、ディマーの設定に問題があります](../Troubleshooting/index.md#_7)。

このLight Brightnessのスライダーは、マイクからの信号に応じて自動で動くようになっています。トーンチャイムを強めに叩いた時に、Light Brightnessが右端までいかなければ、上の方にある、Range-Inputというスライダーを、少しずつ **下げて** 感度を調整します。

実際には音が鳴っていないのに、ライトが細かくちらつく場合は、Smoothingというスライダーの値を **上げて** ください。

## 映像用の設定

![映像のスクリーンショット。映像とチャンネル番号の対応関係が表示されている。左上が1、左下が2、その右隣上が3、下が4、、、と続き、右端が上7、下8とグリッド上に配置されている。](../img/video_screenshot.png)

映像システムでは、チャンネルごとに設定された色を持つ円が、音量に応じて、大きさを変化させます。トーンチャイムのチャンネル番号1~8が、画面上のレイアウトでは画像のように左上1、左下2、その右隣上3、下4、、、と続き、右端が上7、下8とグリッド上に配置されています。

各チャンネルごとの円の色は、映像アプリケーションの設定ウィンドウで、実際の画面上と同じ配置で色のついた四角形が表示されている部分をクリックすると、カラーホイールで設定可能です。

![映像操作アプリケーションのスクリーンショット](../img/videocontroller_ss.png)

トーンチャイムを叩いた時、音量によって3段階で現れる円の映像効果が変化します。大・中・小をどの程度の音量で分割するかは、Detection ThresholdのHigh,Mid,Lowというスライダーで設定します。

![映像パラメーター部分のスクリーンショット](../img/detection_threshold.png)

アプリ下側のVideoという場所で、実際の音量の変化と、3段階の分割位置が表示されているので、音量を変えながら叩いてみて、ちょうど良い分割地点を探してみてください。

また照明と同じように、映像の方にも細かく反応がある場合は、Detection Thresholdのattackというスライダーを上げてみてください。

アプリケーションを終了する前に、うまく動いている状態で再度Save Configを押しておきましょう。

映像アプリケーションの設定は自動的にセーブされます。画面右下の終了ボタンをクリックして終了します。

> [!WARNING]
> 映像アプリケーションの終了は、右下の終了ボタンで終了しないと情報が保存されません。ウィンドウ上の❌ボタンで終了しないようにしてください。